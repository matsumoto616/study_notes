# 本記事の内容
part1では線形ガウス型状態空間モデルの推定アルゴリズムであるカルマンフィルタの導出を追う。Pythonによる実装はpart2で行う。

# 線形ガウス型状態空間モデル
!!! Note  
    tex記法で太字を書くのがしんどいため、本記事ではベクトルや行列を太字表記しない。

$\ell$変量の時系列$y_t\ (t=1,...,T)$を考える。この時系列を表現する次のモデルを（線形ガウス型の）状態空間モデルと呼ぶ。

$$
\begin{align}
x_t &= F_t x_{t-1}+G_tv_t \tag{1}\\
y_t &= H_t x_t+w_t \tag{2}
\end{align}
$$

ここで、
- $x_t$は状態と呼ばれる$k$次元のベクトル
- $v_t$はシステムノイズまたは状態ノイズと呼ばれる、平均ベクトル$0$、分散共分散行列$Q_t$に従う$m$次元の正規白色雑音[^1]
- $w_t$は観測ノイズと呼ばれる、平均ベクトル$0$、分散共分散行列$R_t$に従う$\ell$次元の正規白色雑音
- $F_t$は$k\times k$次元の行列
- $G_t$は$k\times m$次元の行列
- $H_t$は$\ell\times k$次元の行列

である。

$(1)$式はシステムモデルと呼ばれ、（ノイズが加わりながら）状態が時間的に遷移する様子を表す。ノイズはシステムのモデル化誤差と解釈できる。[^2]
$(2)$式は観測モデルと呼ばれ、（ノイズが加わりながら）状態から観測値が計測される様子を表す。ノイズは観測誤差と解釈できる。[^3]

## 例
### 行列成分による書き下し
$l=1, k=2, m=3$の場合、書き下すとこんな感じ。

$$
\begin{align}
\begin{bmatrix}
x_{t,0} \\ x_{t,1}
\end{bmatrix}
&= 
\begin{bmatrix}
F_{t,00} & F_{t,01} \\
F_{t,10} & F_{t,11}
\end{bmatrix}
\begin{bmatrix}
x_{t,0} \\ x_{t,1}
\end{bmatrix}
+
\begin{bmatrix}
G_{t,00} & G_{t,01} & G_{t,02} \\
G_{t,10} & G_{t,11} & G_{t,12}
\end{bmatrix}
\begin{bmatrix}
v_{t,0} \\
v_{t,1} \\
v_{t,2}
\end{bmatrix}
\\
y_t &= \begin{bmatrix}
H_{t,00} & H_{t,01}
\end{bmatrix} \begin{bmatrix}
x_{t,0} \\ x_{t,1}
\end{bmatrix}+w_t
\end{align}
$$

### ARモデル（自己回帰モデル）
$a_i$を自己回帰係数としてARモデル

$$ y_t = \sum_{i=1}^m a_iy_{t-i}+v_t $$

を考える。このとき状態を

$$
x_t=
\begin{bmatrix}
y_t \\
y_{t-1} \\
\vdots \\
y_{t-m+1}
\end{bmatrix}
$$

とすれば、ARモデルは観測ノイズのない（$R_t=0$）、次の状態空間モデルで表現できる[^4] [^5]。

$$
\begin{align}
x_t &=
\begin{bmatrix}
a_1 & a_2 & \cdots & a_m\\
1 \\
& \ddots \\
& & 1 & 0
\end{bmatrix}
x_{t-1}
+
\begin{bmatrix}
1 \\
0 \\
\vdots \\
0 
\end{bmatrix}\\
y_t &= \begin{bmatrix}
1 & 0 & \cdots & 0
\end{bmatrix}
x_t
\end{align}
$$

## 合成モデル
時系列データをトレンド成分と季節周期成分に分解する場合など、$p$個の状態成分に分解して推定したい場合がある。すなわち、$p$個の状態ベクトル$x_t^{(i)}$（$m_i$次元）を用意して、観測モデルが次式で書かれるとする。

$$
y_t = \sum_{i=1}^p H_t^{(i)} x_t^{(i)} + w_t
$$

また、各状態ベクトル$x_t^{(i)T}$は次の状態モデルに従うとする。

$$
x_t^{(i)} = F_t^{(i)} x_{t-1}^{(i)} + G_t^{(i)}v_t
$$

このとき、

$$
\begin{align}
x_t &= 
\begin{bmatrix}
x_t^{(1)T} & x_t^{(2)T} & \cdots & x_t^{(p)T} 
\end{bmatrix}^T, \\
F_t &=
\begin{bmatrix}
F_t^{(1)} & & & \\
& F_t^{(2)} & & \\
& & & \ddots & \\
& & & & F_t^{(p)}
\end{bmatrix}, \\
G_t &=
\begin{bmatrix}
G_t^{(1)} & & & \\
& G_t^{(2)} & & \\
& & & \ddots & \\
& & & & G_t^{(p)}
\end{bmatrix}, \\
H_t &=
\begin{bmatrix}
H_t^{(1)} & H_t^{(2)} & \cdots & H_t^{(p)} 
\end{bmatrix}
\end{align}
$$

とすれば、合成モデルも状態空間モデル$(1)(2)$と全く同様の形式で書くことができる。


# カルマンフィルタによる状態の推定
## 問題の定義
状態空間モデルの目的は観測時系列$y_t$から状態$x_t$を推定することである。後述するように、この状態推定によって時系列の予測から補間、平滑化、尤度計算などが統一的に実現できる。

時刻$T$までの観測値$Y_T\equiv\\{y_1,...,y_T\\}$を用いて、時刻$t$の状態$x_t$を推定する問題を考える。つまり、観測値$Y_T$のもとでの状態$x_t$の条件付き分布$p(x_t|Y_T)$を求める。この問題は観測時刻$T$と推定時刻$t$の関係で呼称が変わる。
- $T<t$の場合：予測 (predicition, forecast)
- $T=t$の場合：フィルタ、濾波 (filtering)
- $T>t$の場合：平滑化 (smoothing)

一般に条件付き同時分布$p(\\{x_1,\cdots, x_t\\}|Y_T)$を求めるには莫大な計算量を要するが、状態空間モデルに対しては逐次的な計算アルゴリズムによって状態$x_t$の条件付き周辺分布を極めて効率的に計算できる。

特に線形ガウス型状態空間モデルの場合、ノイズ$v_t, w_t$が正規分布かつモデルが線形であるため、初期状態$x_0$に正規分布を与えれば正規分布の再生性から各時刻の状態$x_t$も正規分布になる。正規分布は平均ベクトルと分散共分散行列のみで決まるため、これらの遷移だけを計算すればよい。

## カルマンフィルタ
カルマンフィルタは1期先予測（$t=T+1$）とフィルタ（$t=T$）に対するアルゴリズムであり、言い換えれば状態ベクトル$x$のオンライン推定を行う手法である。

表記を簡単にするため、以下では状態$x_t$の条件付き平均ベクトルと分散共分散行列を

$$
\begin{align}
x_{t|T} &\equiv E[x_t|Y_T], \\
V_{t|T} &\equiv V[x_t|Y_T] \equiv E[(x_t-x_{t|T})(x_t-x_{t|T})^T|Y_T],
\end{align}
$$

と書く。[^6]

### 1期先予測
1期先予測では、時刻$t-1$までの観測値$Y_{T-1}=\\{y_1,\cdots,y_{t-1}\\}$を用いて、時刻$t$の平均ベクトル$x_{t|t-1}\equiv E[x_t|Y_{T-1}]$と分散共分散行列$V_{t|t-1}\equiv V[x_t|Y_{T-1}]$を求める。

状態モデルを使うと、平均ベクトルは

$$
\begin{align}
x_{t|t-1} &\equiv E[x_t|Y_{T-1}] \\
&= E[F_t x_{t-1} + G_t v_t|Y_{T-1}] \quad \because \text{状態モデル} \\
&= F_tE[x_{t-1}|Y_{T-1}] \quad \because \text{線形性}, v_t\sim N(0, Q_t) \\
&= F_tx_{t-1|t-1}, \tag{3}
\end{align}
$$

となる。また、分散共分散行列は、

$$
\begin{align}
V_{t|t-1} &\equiv E[(x_t-x_{t|t-1})(x_t-x_{t|t-1})^T|Y_{T-1}] \\
&= E[(F_t (x_t-x_{t-1|t-1}) + G_t v_t)(F_t (x_t-x_{t-1|t-1}) + G_t v_t)^T|Y_{T-1}] \quad \because \text{式}(3)\text{と状態モデル} \\
&= F_tE[(x_t-x_{t-1|t-1})(x_t-x_{t-1|t-1})^T|Y_{T-1}]F_t^T+G_tE[v_tv_t^T]G_t^T \quad \because v_tはホワイトノイズなのでxやyとは無相関 \\
&= F_tV_{t-1|t-1}F_t^T+G_tQ_tG_t^T, \tag{4}
\end{align}
$$

となる。

### フィルタ
フィルタでは、上記で求めた$x_{t|t-1}, V_{t|t-1}$と観測値$y_t$を用いて、観測値$Y_{T}$のもとでの平均ベクトル$x_{t|t}\equiv E[x_t|Y_{T}]$と分散共分散行列$V_{t|t}\equiv V[x_t|Y_{T}]$を求める。

これは次のベイズ推定の問題として捉えることができる。つまり、

$$
\begin{align}
p(x_t|Y_{T-1})&=N(x_{t|t-1},V_{t|t-1}) \tag{5},
\end{align}
$$

を事前分布としたうえで、観測値$y_t$が与えられた際の事後分布

$$
\begin{align}
p(x_t|Y_{T})=N(x_{t|t}, V_{t|t}) \tag{6},
\end{align}
$$

をベイズの定理から求める。

ここで、観測モデル（式$(2)$の別表現）

$$
\begin{align}
p(y_t|x_t)&=N(H_tx_t, R_t) \tag{7},
\end{align}
$$

が成立していることを用いると、カルマンゲインと呼ばれる量

$$
\begin{align}
K_t &= V_{t|t-1}H_t^T(H_tV_{t|t-1}H^T+R_t)^{-1} \tag{8},
\end{align}
$$

を定義して、事後分布の平均ベクトル・分散共分散行列は

$$
\begin{align}
x_{t|t} &= x_{t|t-1}+K_t(y_t-H_tx_{t|t-1}) \tag{9}, \\
V_{t|t} &= V_{t|t-1}-K_tH_tV_{t|t-1}, \tag{10}
\end{align}
$$

と書けることが知られている。この計算は少々込み入っているのでここでは割愛するが、いずれ別記事にまとめたい。

式$(9)$は予測誤差$y_t-H_tx_{t|t-1}$を用いて状態ベクトルを補正する効果を表しており、式$(10)$は$y_t$の観測によって状態推定の精度が改善される（分散が小さくなる）効果を表している。

### カルマンフィルタのまとめ
カルマンフィルタのアルゴリズムをまとめる。

**[カルマンフィルタ]**
初期状態$x_0=N(x_{0|0}, V_{0|0})$を用意し、$t=1,\cdots,T$に対して以下を逐次実行する。

**一期先予測**

$$
\begin{align}
x_{t|t-1} &= F_tx_{t-1|t-1}, \tag{3} \\
V_{t|t-1} &= F_tV_{t-1|t-1}F_t^T+G_tQ_tG_t^T, \tag{4}
\end{align}
$$

**フィルタ**

$$
\begin{align}
K_t &= V_{t|t-1}H_t^T(H_tV_{t|t-1}H^T+R_t)^{-1} \tag{8}, \\
x_{t|t} &= x_{t|t-1}+K_t(y_t-H_tx_{t|t-1}) \tag{9}, \\
V_{t|t} &= V_{t|t-1}-K_tH_tV_{t|t-1}, \tag{10}
\end{align}
$$

## 固定区間平滑化
平滑化は観測値$Y_{T}$が与えられたとき、途中の時刻$t(<T)$の状態$x_t$を推定する問題である。つまり、これは状態ベクトル$x$のオフライン推定を行う問題である。この平滑化問題に対しては、カルマンフィルタと類似した固定区間平滑化と呼ばれるアルゴリズムがある。

固定区間平滑化を行う場合は、事前準備としてあらかじめ前述のカルマンフィルタを$t=1,\cdots, T$に対して実行しておく必要がある。カルマンフィルタによって得られる予測分布$\\{x_{t|t-1}, V_{t|t-1}\\}$とフィルタ分布$\\{x_{t|t}, V_{t|t}\\}$を所与としたうえで、次のアルゴリズムによって平滑化分布$\\{x_{t|T}, V_{t|T}\\}$を求めることができる。導出はフィルタの項と同じくやや複雑なため割愛する（機会があれば記事にします）。

**[固定区間平滑化]**
初期状態$x_0=N(x_{0|0}, V_{0|0})$を用意し、$t=1,\cdots,T$に対してカルマンフィルタを逐次実行し、全時刻の予測分布$\\{x_{t|t-1}, V_{t|t-1}\\}$とフィルタ分布$\\{x_{t|t}, V_{t|t}\\}$を取得しておく。その後、時刻の逆順$t=T-1,\cdots,1$に対して以下を逐次実行する。

$$
\begin{align}
A_{t} &= V_{t|t}F_{t+1}^TV_{t+1|t}^{-1}, \tag{11} \\
x_{t|T} &= x_{t|t} + A_t(x_{t+1|T}-x_{t+1|t}), \tag{12} \\
V_{t|T} &= V_{t|t} + A_t(V_{t+1|T}-V_{t+1|t})A_t^T, \tag{13}
\end{align}
$$

# カルマンフィルタの周辺
## 状態の長期予測
カルマンフィルタは直接的には1期先予測を与えるアルゴリズムだが、少し工夫することで長期予測を行うこともできる。時刻$T$までの観測値$Y_{T}\equiv\\{y_1,...,y_T\\}$を用いて、時刻$T+j\ (j>1)$の状態$x_{T+j}$を推定する問題を考える。

まずカルマンフィルタ$(3)(4)$によって予測分布$\\{x_{T+1|T}, V_{T+1|T}\\}$が求まる。しかし、観測値$y_{T+1}$が得られていないので、そのままではフィルタ分布を求めることができない。そこで、観測値集合$Y_{T+1}$を形式的に$Y_{T}$とみなすことにする。すると、式$(5)(6)$より事前分布と事後分布が等しくなるから、単に$x_{t|t}=x_{t|t-1},\ V_{t|t}=V_{t|t-1}$とすればよいことがわかる。これはカルマンフィルタのアルゴリズムにおいて、予測ステップのみを実行しフィルタステップを省略すればよいことを示している。この考え方はこの後出てくる欠測値の処理にも応用できる。

結局、状態の長期予測のアルゴリズムは次のようになる。

**[状態の長期予測]**
カルマンフィルタによって状態$x_T=N(x_{T|T}, V_{T|T})$を得たあと、$i=1,\cdots,j$に対して以下を逐次実行する。

$$
\begin{align}
x_{T+i|T} &= F_{T+i}x_{T+i-1|T}, \tag{14} \\
V_{T+i|T} &= F_{T+i}V_{T+i-1|T}F_{T+i}^T+G_{T+i}Q_{T+i}G_{T+i}^T, \tag{15}
\end{align}
$$

## 観測値の分布の計算
ここまでは状態$x_t$の推定方法を見てきたが、観測値$y_t$自体の分布を計算することもできる。カルマンフィルタや固定区間平滑化によって、観測値$Y_{T}$が得られたもとでの状態の条件付き分布$\\{x_{t|T}, V_{t|T}\\}$を計算しておく。そこで観測モデル$(2)$を用いると、$(3)(4)$と全く同様の計算によって$y_{t}$の平均ベクトルと分散共分散行列が求まる。

$$
\begin{align}
y_{t|T} &\equiv E[y_{t}|Y_{T}]=H_{t}x_{t|T}, \tag{16} \\
D_{t|T} &\equiv V[y_{t}|Y_{T}]=H_{t}V_{t|T}H_{t}^T+R_{t}, \tag{17}
\end{align}
$$

## 尤度計算とパラメータ推定
ノイズの分散共分散行列$Q_t, R_t$など、時系列モデルのパラメータをまとめて$\theta$とおく。$Y_{T}$の同時密度関数$f_T(Y_{T}|\theta)$を用いると、このモデルの尤度は

$$
\begin{align}
L(\theta) = f_T(Y_{T}|\theta),
\end{align}
$$

となる。

ここで、$Y_{t}$の同時密度関数は$Y_{t-1}$の同時密度関数と$Y_{t-1}$のもとでの$y_t$の予測分布$g_t(y_t|Y_{t-1},\theta)$の積に分解でき、

$$
\begin{align}
f_t(Y_{t}|\theta) = f_{t-1}(Y_{t-1}|\theta)g_t(y_t|Y_{t-1},\theta),
\end{align}
$$

が成立する。これを用いると、

$$
\begin{align}
L(\theta) =  \prod_{t=1}^T g_t(y_t|Y_{t-1},\theta),
\end{align}
$$

となる。ここで、$f_1(y_1|\theta)\equiv g_1(y_1|Y_{0},\theta),\ Y_{0}\equiv \emptyset$とした。

観測値の予測の議論を思い出すと、$g_t(y_t|Y_{t-1})$は平均ベクトル$y_{t|t-1}$、分散共分散行列$D_{t|t-1}$の正規分布となる。具体的に書き下すと

$$
\begin{align}
g_t(y_t|Y_{t-1}) = \left( \frac{1}{\sqrt{2\pi}}\right)^\ell |D_{t|t-1}|^{-\frac{1}{2}}\exp\left[ -\frac{1}{2}(y_t-y_{t|t-1})^T D_{t|t-1}^{-1}(y_t-y_{t|t-1})\right],
\end{align}
$$

である。したがって、モデルの対数尤度$\ell(\theta)$は、

$$
\begin{align}
\ell(\theta)=\ln L(\theta) &= \sum_{t=1}^T \ln g_t(y_t|Y_{t-1})\\
&= -\frac{1}{2}\left[ \ell T\ln{2\pi}+\sum_{t=1}^T \ln |D_{t|t-1}| +\sum_{t=1}^T(y_t-y_{t|t-1})^T D_{t|t-1}^{-1}(y_t-y_{t|t-1})\right] \tag{18},
\end{align}
$$

によって求められる。

カルマンフィルタで状態の分布$\\{x_{t|t-1}, V_{t|t-1}\\}$を求めるついでに、$(16)(17)$から観測値の分布$\\{y_{t|t-1}, D_{t|t-1}\\}$を計算しておけば、$(18)$より尤度計算もあわせて行うことができる。パラメータの最尤推定を行う場合はL-BFGS法などの数値的最適化法を利用すればよい。

$$
\begin{align}
\hat{\theta} = \mathrm{argmax}\  \ell(\theta)
\end{align}
$$

## 欠測値の処理
なんらかの要因で時系列の一部が観測できない場合がある。その観測できなかったデータを欠測値と呼ぶ。欠測値の推定自体も重要な問題だが、欠測値があると予測精度が悪化する（手法によっては予測ができなくなる）場合があるため、欠損値の処理は重要である。

よくある方法としては、0やデータの代表値で置き換えたり、なんらかの補間法（スプライン補間など）によって補間するやり方がある。しかし、この方法は時系列に対して勝手なモデルを仮定していることに相当し、使い方がまずいと解析結果に悪影響をもたらす。状態空間モデルを用いると、このような（システムモデル以外の）勝手なモデルを仮定せずとも、自然に欠測値の処理を行うことができる。

$I(T)$を値が観測された時刻$t (\leq T)$の集合とする。このとき、$Y_{T}\equiv \\{y_t|t\in 
 I(T)\\}$と再定義すると、欠測値がある場合のカルマンフィルタは次のようになる。

**[欠測値がある場合のカルマンフィルタ]**
初期状態$x_0=N(x_{0|0}, V_{0|0})$を用意し、$t=1,\cdots,T$に対して以下を逐次実行する。

**一期先予測**

$$
\begin{align}
x_{t|t-1} &= F_tx_{t-1|t-1}, \\
V_{t|t-1} &= F_tV_{t-1|t-1}F_t^T+G_tQ_tG_t^T,
\end{align}
$$

**フィルタ（$t\in I(T)$の場合）**

$$
\begin{align}
K_t &= V_{t|t-1}H_t^T(H_tV_{t|t-1}H^T+R_t)^{-1}, \\
x_{t|t} &= x_{t|t-1}+K_t(y_t-H_tx_{t|t-1}), \\
V_{t|t} &= V_{t|t-1}-K_tH_tV_{t|t-1},
\end{align}
$$

**フィルタ（$t\notin I(T)$の場合）**

$$
\begin{align}
x_{t|t} &= x_{t|t-1}, \\
V_{t|t} &= V_{t|t-1},
\end{align}
$$

----
カルマンフィルタによって状態の予測分布$\\{x_{t|t-1}, V_{t|t-1}\\}$とフィルタ分布$\\{x_{t|t}, V_{t|t}\\}$が得られれば、平滑化（これが欠測値の補間を与える）や$x_t,y_t$の予測は式$(11)\sim(17)$で計算できる。

また、欠測値がある場合の対数尤度は、

$$
\begin{align}
\ell(\theta)&= \sum_{t\in I(T)} \ln g_t(y_t|Y_{t-1})\\
&= -\frac{1}{2}\sum_{t\in I(T)}\left[ \ell \ln{2\pi}+\ln |D_{t|t-1}| +(y_t-y_{t|t-1})^T D_{t|t-1}^{-1}(y_t-y_{t|t-1})\right],
\end{align}
$$

となり、最尤法によるパラメータ推定も同じように可能である。

# まとめ
本記事では線形ガウス型状態空間モデルとその推定アルゴリズムであるカルマンフィルタを紹介した。カルマンフィルタ（と固定区間平滑化）によって、時系列データの状態推定や（短期・長期）予測が可能であることを確認できた。また、最尤法による状態空間モデルのパラメータ推定法も示した。この結果は、欠測値がある場合にも自然に拡張できる。part2ではpythonによる実装を行い、本記事の結果をデータを用いて確認してみる予定である。

# 参考文献
- 北川源四郎「Rによる時系列モデリング入門」
- 中野慎也「データ科学：理論から実用へII」（大学の講義資料）

[^1]: つまり$v_t$の確率密度関数は

$$f(v_t)=\frac{1}{\sqrt{(2\pi)^m|Q_t|}}\exp{\left(-\frac{1}{2}v_t^TQ_t^{-1}v_t\right)}$$

であり、$E[v_{t_1}v_{t_2}^T]=0\ (t_1 \neq t_2)$である。また、状態ベクトルや観測値とも無相関である。（多分）
[^2]: システムモデルが$$x_t=F_t x_{t-1}+ v_t$$と定義されている文献もある。この場合は$v_t$は$k$次元ベクトル。
[^3]: 観測モデルを$$y_t=H_t x_t+I_t w_t$$と定義している文献は（今のところ）見たことがないが、理由はよくわからない。観測誤差は$l$個の観測値それぞれに乗ると考えられるから...？
[^4]: 状態空間表現は一意的ではない。任意の正則行列$T$を$(1)$式に左からかけると、状態を$z_t(=Tx_t)$とした、同値な状態空間表現が得られる。
[^5]: 状態モデルは$m$本の方程式となるが、1本目がARモデルに対応し、残りは自明な式（$y_{t-1}=y_{t-1},\ y_{t-2}=y_{t-2},\ \cdots\ ,\ y_{t-m+1}=y_{t-m+1}$）である。
[^6]: 北川先生の本では$Y_{T}$のもとでの条件付き分散となっておらず、$V_{t|T} \equiv E[(x_t-x_{t|T})(x_t-x_{t|T})^T]$というような表記だったが、必要な気がしたので書いた。
